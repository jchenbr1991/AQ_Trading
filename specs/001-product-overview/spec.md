# Product Specification: AQ Trading - 算法交易系统

**Feature Branch**: `001-product-overview`
**Created**: 2026-01-31
**Status**: Draft
**Input**: 基于 STRATEGY.md 和 BACKLOG.md 的产品全景规格文档

## 产品概述

AQ Trading 是一个面向个人量化交易者的全栈算法交易系统。系统支持美股、期货和期权交易，通过富途（moomoo）券商 API 执行订单，提供从策略开发、回测验证到实盘执行的完整工作流。

**目标用户**: 个人量化交易者，具备编程能力，需要系统化管理交易策略

**核心价值**:
- 安全可控的自动化交易执行
- 完整的策略回测与绩效分析
- 实时风险监控与保护机制
- 期权/期货衍生品生命周期管理

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 安全执行策略交易 (Priority: P1) [已完成]

作为量化交易者，我需要在模拟盘和实盘环境中安全执行交易策略，实时追踪持仓和盈亏，并在必要时手动干预。

**Why this priority**: 这是交易系统的核心功能。没有安全可靠的交易执行，其他功能都没有意义。

**Status Note**: 此功能已在 Phase 1 完成（参见 BACKLOG.md）。

**Independent Test**: 可以通过在模拟盘运行一个简单策略，观察订单执行、持仓更新、盈亏计算的完整流程来验证。

**Acceptance Scenarios**:

1. **Given** 一个已配置的交易策略和模拟账户，**When** 策略产生买入信号，**Then** 系统应验证风控限制、提交订单、更新持仓、记录交易日志
2. **Given** 系统正在运行交易策略，**When** 用户通过 Dashboard 点击"暂停策略"，**Then** 策略应立即停止产生新信号，现有订单可选择保留或取消
3. **Given** 账户日内亏损达到预设限额，**When** 策略尝试开新仓，**Then** 系统应拒绝该信号并触发警报
4. **Given** 与券商的连接中断，**When** 系统检测到断开，**Then** 应自动取消所有未成交订单并通知用户

---

### User Story 2 - 回测策略验证绩效 (Priority: P2) [已完成]

作为量化交易者，我需要使用历史数据回测交易策略，评估其绩效指标，并与基准进行对比，以决定是否投入实盘。

**Why this priority**: 回测是策略上线前的必要验证步骤，直接影响资金安全。

**Status Note**: 此功能已在 Phase 2 完成（参见 BACKLOG.md Slice 2.2, 2.3, 2.4）。

**Independent Test**: 可以通过对一个样本策略运行历史回测，查看生成的绩效报告和基准对比来验证。

**Acceptance Scenarios**:

1. **Given** 一个策略和指定的历史时间段，**When** 用户启动回测，**Then** 系统应模拟执行策略并生成包含夏普比率、最大回撤、胜率等指标的报告
2. **Given** 回测配置中指定了基准（如 SPY），**When** 回测完成，**Then** 报告应包含 Alpha、Beta、信息比率等与基准的对比指标
3. **Given** 策略需要历史指标数据（如 200 日均线），**When** 回测开始，**Then** 系统应自动预热策略所需的历史 bars 数据
4. **Given** 回测完成，**When** 用户查看交易追溯，**Then** 应能看到每笔交易的信号原因、市场快照、滑点分析

---

### User Story 3 - 监控系统健康状态 (Priority: P2) [已完成]

作为交易系统运维者，我需要实时监控各组件的健康状态，以便及时发现和处理问题，保障交易系统稳定运行。

**Why this priority**: 交易系统的稳定性直接关系到资金安全，任何组件故障都可能导致损失。

**Status Note**: 此功能已在 Phase 2 完成（参见 BACKLOG.md Slice 2.1）。

**Independent Test**: 可以通过访问健康监控页面，验证各组件状态显示和告警机制。

**Acceptance Scenarios**:

1. **Given** 系统正常运行，**When** 用户访问健康监控页面，**Then** 应显示所有组件（数据库、缓存、券商连接、行情服务）的实时状态
2. **Given** Redis 服务出现延迟或故障，**When** 健康检查检测到异常，**Then** 系统应标记该组件为异常状态并发送告警
3. **Given** 行情数据超过预设时间未更新，**When** 系统检测到数据过时，**Then** 应标记行情服务为异常状态并发送告警

---

### User Story 4 - 管理衍生品生命周期 (Priority: P3)

作为期权/期货交易者，我需要系统自动追踪合约到期日，在到期前提醒我处理持仓，并在必要时自动执行换月或平仓操作。

**Why this priority**: 衍生品有明确的到期日，错过处理时机可能导致被动行权或强制平仓。

**Independent Test**: 可以通过持有一个即将到期的期权仓位，验证系统的到期提醒和建议处理流程。

**Acceptance Scenarios**:

1. **Given** 持有一个 5 天内到期的期权仓位，**When** 系统执行每日到期检查，**Then** 应向用户发送到期警告通知
2. **Given** 期权到期且处于价内状态，**When** 到期日当天，**Then** 系统应预估行权后的股票仓位变化并提前通知用户
3. **Given** 持有一个即将到期的期货合约，**When** 距到期不足预设天数，**Then** 系统应根据配置自动启动换月流程或通知用户手动处理

---

### User Story 5 - 实时监控组合Greeks (Priority: P2) [已完成]

作为期权交易者，我需要实时查看组合的 Delta、Gamma、Theta、Vega 等Greeks暴露，并在超出阈值时收到警报。

**Why this priority**: Greeks暴露直接反映期权组合的风险敞口，是期权交易风控的核心指标。

**Status Note**: 此功能已在 Phase 2 完成（参见 BACKLOG.md Slice 2.6）。

**Independent Test**: 可以通过持有期权仓位后查看Greeks仪表板，验证数值计算和阈值告警。

**Acceptance Scenarios**:

1. **Given** 账户持有期权仓位，**When** 用户访问Greeks监控页面，**Then** 应显示账户级和策略级的 Delta、Gamma、Theta、Vega 聚合值
2. **Given** 组合 Delta 超过预设警戒阈值，**When** 系统检测到突破，**Then** 应触发告警并在 Dashboard 显示警告
3. **Given** 用户想评估市场变动影响，**When** 用户请求情景分析，**Then** 系统应计算标的价格 ±1%/±2% 时的组合盈亏预估

---

### User Story 6 - AI 代理辅助优化 (Priority: P4)

作为量化交易者，我需要 AI 代理分析我的交易表现，提供策略优化建议，并自动调整风险偏好参数。

**Why this priority**: AI 代理是提升效率的高级功能，但需要稳定的交易核心作为基础。

**Independent Test**: 可以通过触发策略优化分析任务，验证 AI 代理的分析报告和参数建议。

**Acceptance Scenarios**:

1. **Given** 一个策略近期表现不佳，**When** 用户触发优化分析，**Then** Researcher 代理应运行回测、分析参数敏感性、生成优化建议报告
2. **Given** 市场波动率升高（VIX > 25），**When** Risk Controller 代理评估市场环境，**Then** 应自动降低全局风险偏好系数，减小所有策略的仓位限制
3. **Given** 本地仓位与券商仓位不一致，**When** Ops 代理执行对账检查，**Then** 应分析差异原因并生成修复建议

---

### Edge Cases

- **网络中断恢复**: 券商连接恢复后，系统如何同步中间错过的成交回报和仓位变化？
- **部分成交处理**: 订单部分成交后券商连接中断，如何确保仓位数据一致性？
- **跨日持仓处理**: 股票分红、拆股、期权调整等公司行为如何自动更新仓位成本？
- **并发信号冲突**: 多个策略同时对同一标的产生相反方向的信号，如何协调处理？
- **极端行情保护**: 标的价格瞬间大幅波动（如熔断），系统如何保护未成交订单？

## Requirements *(mandatory)*

### Functional Requirements

#### 核心交易 (Phase 1)

- **FR-001**: 系统 MUST 支持多资产类型持仓追踪（股票、期权、期货），记录每个仓位的成本、市值、未实现盈亏
- **FR-002**: 系统 MUST 提供策略框架，支持策略接收行情数据、维护内部状态、产生交易信号
- **FR-003**: 系统 MUST 实现多层风控检查：单标的仓位限制、组合总敞口限制、日亏损限制
- **FR-004**: 系统 MUST 支持订单生命周期管理：创建、提交、部分成交、全部成交、取消、拒绝
- **FR-005**: 系统 MUST 定期与券商同步仓位数据，检测并报告差异
- **FR-006**: 系统 MUST 支持模拟盘模式，使用真实行情但模拟成交，用于策略验证
- **FR-007**: 系统 MUST 提供 Web Dashboard，显示持仓、盈亏、订单，支持暂停策略和紧急平仓
- **FR-008**: 系统 MUST 缓存实时行情数据，支持策略快速读取最新报价

#### 分析验证 (Phase 2)

- **FR-009**: 系统 MUST 支持历史数据回测，使用与实盘相同的策略代码
- **FR-009a**: 系统 MUST 支持策略预热（Warm-up），在启动时自动加载历史数据初始化策略指标状态
- **FR-010**: 系统 MUST 计算回测绩效指标：总收益、夏普比率、最大回撤、胜率、盈亏比
- **FR-011**: 系统 MUST 支持与基准对比，计算 Alpha、Beta、信息比率、上行/下行捕获率
- **FR-012**: 系统 MUST 记录每笔交易的完整追溯：信号原因、市场快照、风控检查结果、滑点分析
- **FR-013**: 系统 MUST 监控各组件健康状态，支持状态监控和告警
- **FR-014**: 系统 MUST 实现数据保留策略，自动清理过期数据，压缩历史数据
- **FR-015**: 系统 MUST 计算期权组合的Greeks，支持账户级和策略级聚合

#### 高级功能 (Phase 3)

- **FR-016**: 系统 MUST 追踪衍生品到期日，在到期前预设天数发送警告
- **FR-017**: 系统 MUST 支持期货自动换月，可配置换月策略（价差换月或平仓开仓）
- **FR-018**: 系统 MUST 处理期权到期行权/被行权，预估并记录股票仓位变化
- **FR-019**: 系统 MUST 支持 AI 代理子系统，代理可执行数据分析、策略优化等任务
- **FR-020**: AI 代理 MUST 有明确的权限边界：只能读取数据和调整参数，不能直接下单
- **FR-021**: 系统 MUST 实现优雅降级，在组件故障时自动切换到安全模式
- **FR-022**: Analyst 代理 MUST 支持情绪因子生成，将新闻/社交媒体数据转化为策略可用的结构化因子
- **FR-023**: Researcher 代理 MUST 支持策略参数自动调优，包含防过拟合的样本外验证机制

### Key Entities

- **Account**: 交易账户，包含账户 ID、券商、货币、可用资金、已用保证金
- **Position**: 持仓记录，包含标的代码、资产类型、数量、成本、当前价、策略归属
- **Order**: 订单，包含订单类型、方向、数量、价格、状态、券商订单 ID
- **Transaction**: 成交记录，用于计算精确成本和已实现盈亏
- **Strategy**: 交易策略，包含配置参数、运行状态、绩效统计
- **Signal**: 策略产生的交易信号，包含方向、数量、止损设置、信号原因
- **SignalTrace**: 交易追溯，记录信号产生时的完整上下文
- **GreeksSnapshot**: Greeks快照，记录特定时刻的组合风险敞口

## Success Criteria *(mandatory)*

### Measurable Outcomes

#### 交易执行

- **SC-001**: 用户可以在 5 分钟内完成策略配置并启动模拟盘交易
- **SC-002**: 从策略信号产生到订单提交的延迟不超过 500 毫秒
- **SC-003**: 系统支持同时运行 10 个独立策略，追踪 100 个持仓
- **SC-004**: 紧急平仓操作（kill switch）可在 3 秒内触发所有持仓的平仓订单

#### 回测分析

- **SC-005**: 用户可以在 30 秒内完成一年历史数据的单策略回测
- **SC-006**: 回测结果包含至少 15 项标准绩效指标
- **SC-007**: 每笔交易追溯记录可在 2 秒内检索显示

#### 系统可靠性

- **SC-008**: 系统健康检查每 10 秒更新一次，故障检测延迟不超过 30 秒
- **SC-009**: 券商连接断开后，系统在 60 秒内自动重连或发送告警通知用户
- **SC-010**: 本地仓位与券商仓位的对账差异率低于 0.1%

#### 衍生品管理

- **SC-011**: 用户至少提前 5 天收到衍生品到期警告
- **SC-012**: Greeks计算结果与市场标准模型的偏差低于 5%

#### AI 代理

- **SC-013**: AI 代理生成的优化建议必须包含样本外测试验证
- **SC-014**: 代理的风险偏好调整在 1 分钟内生效于所有策略

## Assumptions

- 用户已有富途（moomoo）券商账户并获取了 API 访问权限
- 用户具备基本的 Python 编程能力，能够编写和修改策略代码
- 系统主要供单用户使用，不考虑多租户场景
- 历史行情数据通过券商 API 或第三方数据源获取，本规格不涉及数据采集
- AI 代理使用外部 LLM 服务，本规格假设 LLM API 可用

## Dependencies

- 券商 API 访问可用且稳定
- 时序数据库用于存储行情和交易数据
- 缓存服务用于实时行情缓存和消息发布
- 大语言模型服务（用于 AI 代理功能）
